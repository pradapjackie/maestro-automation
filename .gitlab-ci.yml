image: openjdk:11-jdk

stages:
  - test
  - report

# Job to install dependencies and set up the environment
before_script:
  # Install dependencies
  - apt-get update -y
  - apt-get install -y curl unzip tar

  # Install Android SDK
  - apt-get install -y android-sdk

  # Download Maestro
  - curl -L https://github.com/mobile-dev-inc/maestro/releases/download/v0.9.7/maestro-0.9.7-linux-x86_64.tar.gz -o maestro.tar.gz
  
  # Extract Maestro
  - if file maestro.tar.gz | grep -q 'gzip compressed data'; then tar -xzvf maestro.tar.gz; else echo "File is not a valid tar.gz"; exit 1; fi
  
  # Add Maestro to PATH
  - export PATH=$PATH:$CI_PROJECT_DIR/maestro

# Job to run Maestro tests
maestro_test:
  stage: test
  script:
    - adb install sample.apk  # Replace with actual APK path if necessary
    - maestro test android.yaml --format junit --output results.xml
  artifacts:
    paths:
      - results.xml

# Job to generate Allure report
allure_report:
  stage: report
  image: "alpine:latest"
  script:
    - apk add --no-cache allure
    - mkdir -p allure-results
    - mv results.xml allure-results/
    - allure serve allure-results
  dependencies:
    - maestro_test
  artifacts:
    paths:
      - allure-results
  only:
    - main  # Or your desired branch
